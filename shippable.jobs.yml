jobs:
  - name: ztimer-image
    type: runCLI
    steps:
      - IN: ztimer-docker-cli-config
      - TASK:
        - script: npm install ztimer.ui@rc
        - script: docker build node_modules/ztimer.ui -t zthun/ztimer:rc
        - script: docker push zthun/ztimer:rc
      - OUT: ztimer-rc-image

  - name: ztimer-manifest
    type: manifest
    steps:
      - IN: ztimer-image
      - IN: ztimer-rc-image
      - IN: core-docker-options
      - TASK: managed

  - name: ztimer-deploy-stage
    type: deploy
    steps:
      - IN: ztimer-manifest
      - IN: zthunworks-aws-stage-cluster
      - TASK: managed

  - name: ztimer-deploy-prod
    type: deploy
    steps:
      - IN: ztimer-deploy-stage
        switch: off
      - IN: zthunworks-aws-prod-cluster
      - TASK: managed

  - name: ztimer-update-docker-image
    type: runCLI
    steps:
      - IN: ztimer-docker-cli-config
      # - IN: ztimer-deploy-prod
      - TASK:
        - script: >
                  version=$(npm dist-tag ls ztimer.ui | grep rc)
        - script: echo $version
        - script: docker pull zthun/ztimer:rc
        - script: semvar=${version//rc:/}
        - script: echo $semvar
        - script: docker tag zthun/ztimer:rc zthun/ztimer:$semvar
        - script: docker tag zthun:ztimer:rc zthun/ztimer:latest
        # - script: docker push zthun:ztimer:$semvar
        # - script: docker push zthun:ztimer:latest
